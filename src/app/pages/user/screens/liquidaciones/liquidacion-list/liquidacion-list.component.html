<section class="bg-gray-50 dark:bg-gray-900 min-h-screen p-6">
  <div class="max-w-5xl mx-auto bg-white/10 backdrop-blur-md rounded-lg shadow-lg p-6">
    <h1 class="text-2xl font-bold mb-4 text-center text-gray-900 dark:text-white">
      Lista de Liquidaciones
    </h1>

    <div *hasRole="['User']" class="flex justify-end mb-4">
      <button (click)="irACrearLiquidacion()"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-md">
        Crear Liquidaci√≥n
      </button>
    </div>

    <div *ngIf="successMessage" class="text-green-600 font-medium mb-2">
      {{ successMessage }}
    </div>

    <div *ngIf="errorMessage" class="text-red-600 font-medium mb-2">
      {{ errorMessage }}
    </div>

    <div class="overflow-x-auto">
      <table class="w-full border-collapse rounded-lg shadow-sm">
        <thead class="text-white bg-gray-800">
          <tr>
            <th class="p-3 text-left">Contrato</th>
            <th class="p-3 text-left">Servicio</th>
            <th class="p-3 text-left">Usuario</th>
            <th class="p-3 text-left">Cantidad</th>
            <th class="p-3 text-left">Total</th>
            <th class="p-3 text-left">Estado</th>
            <th class="p-3 text-left">Fecha</th>
            <th *hasRole="['Admin','User']" class="p-3 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let liquidacion of liquidaciones; let i = index" class="border-b">
            <td class="p-3">{{ liquidacion.contratoObjeto }}</td>
            <td class="p-3">{{ liquidacion.servicioNombre }}</td>
            <td class="p-3">{{ liquidacion.usuarioNombre }}</td>

            <td class="p-3">
                <ng-container *ngIf="editIndex === i; else showCantidad">
                  <!-- Si es User puede editar, si no solo lectura -->
                  <ng-container *ngIf="role === 'User'; else cantidadSoloLectura">
                    <input 
                      type="number" 
                      min="1" 
                      [(ngModel)]="liquidacion.cantidad"
                      (ngModelChange)="recalcularTotal(liquidacion)"
                      class="border rounded p-1 w-20"
                    />
                </ng-container>

                <ng-template #cantidadSoloLectura>
                    {{ liquidacion.cantidad }}
                  </ng-template>
                </ng-container>

                <ng-template #showCantidad>
                  {{ liquidacion.cantidad }}
                </ng-template>
            </td>


            <td class="p-3 text-right">
              {{ liquidacion.total | currency }}
            </td>

            <td class="p-3">
              <ng-container *ngIf="editIndex === i; else showEstado">
                <select
                    [(ngModel)]="liquidacion.estado"
                    *ngIf="role === 'Admin'; else estadoSoloLectura"
                  >
                    <option value="Pendiente">Pendiente</option>
                    <option value="Aprobado">Aprobada</option>
                    <option value="Rechazado">Rechazado</option>
                </select>
              <ng-template #estadoSoloLectura>
                {{ liquidacion.estado }}
              </ng-template>

              </ng-container>
              <ng-template #showEstado>{{ liquidacion.estado }}</ng-template>
            </td>

            <td class="p-3">{{ liquidacion.fecha | date:'shortDate' }}</td>

            <td class="p-3 text-center">
              <ng-container *ngIf="editIndex === i; else normalButtons">
                <button (click)="guardarEdicion(liquidacion, i)"
                        class="bg-green-600 text-white px-3 py-1 rounded mr-2">Guardar</button>
                <button (click)="cancelarEdicion()"
                        class="bg-gray-400 text-white px-3 py-1 rounded">Cancelar</button>
              </ng-container>
              <ng-template #normalButtons>
                <button (click)="editarLiquidacion(i)"
                  class="bg-blue-600 text-white px-3 py-1 rounded mr-2">
                  Editar
                </button>
                <!-- <button (click)="editarLiquidacion(i)"
                  class="bg-blue-600 text-white px-3 py-1 rounded mr-2">
                  Editar
                </button> -->
                <button *hasRole="['User']" (click)="eliminarLiquidacion(liquidacion.id)"
                  class="bg-red-600 text-white px-3 py-1 rounded">
                  Eliminar
                </button>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
